#!/usr/bin/env bash
# Version: MPL 1.1 / GPLv3+ / LGPLv3+
#
# The contents of this file are subject to the Mozilla Public License Version
# 1.1 (the "License"); you may not use this file except in compliance with
# the License or as specified alternatively below. You may obtain a copy of
# the License at http://www.mozilla.org/MPL/
#
# Software distributed under the License is distributed on an "AS IS" basis,
# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
# for the specific language governing rights and limitations under the
# License.
#
# The Initial Developer of the Original Code is
#       David Tardon, Red Hat Inc. <dtardon@redhat.com>
# Portions created by the Initial Developer are Copyright (C) 2010 the
# Initial Developer. All Rights Reserved.
#
# Major Contributor(s):
#
# For minor contributions see the git repository.
#
# Alternatively, the contents of this file may be used under the terms of
# either the GNU General Public License Version 3 or later (the "GPLv3+"), or
# the GNU Lesser General Public License Version 3 or later (the "LGPLv3+"),
# in which case the provisions of the GPLv3+ or the LGPLv3+ are applicable
# instead of those above.

GDBDIR="${SOLARENV}/gdb"
SOLVERLIBDIR="${SOLARVER}/${INPATH}/lib"
INSTALLDIR="${SOLARVER}/${INPATH}/installation/opt"

die() {
    echo "$1" >&2
    exit 1
}

make_autoload() {
    local dir="${DESTDIR}${autoloaddir}"
    ${flat} || dir="${dir}/$2"
    local lib="${dir}/$3"

    if ! ${flat}; then
        lib="$(readlink -f "${DESTDIR}${installdir}/$2/$3")"
        dir="${lib%/*}"
    fi

    if ${create}; then
        mkdir -p "${dir}" || die "cannot create dir '${dir}'"
    fi

    if ${link}; then
        if [[ ! -f ${lib}-gdb.py ]]; then
            local gdbname="${lib##*/}-gdb.py"
            ln -s "${SOLVERLIBDIR}/${gdbname}" "${dir}/${gdbname}"
        fi
    else
        sed -e "s!%PYTHONDIR%!${pythondir}!" -e "s!%MODULE%!libreoffice.$1!" \
            "${GDBDIR}/autoload.template" > "${lib}-gdb.py"
    fi
}

# dir where the autoloaders will be placed
autoloaddir=
# The installation dir. If only one of these is set, the other is set to
# the same value.
installdir=
# dir where the pretty printers will be placed
pythondir="${GDBDIR}"
# Create autoload dir if it does not exist. This only makes sense when
# installing into system gdb dir, so $autoloaddir must be absolute path.
create=false
# Create symlinks to existing autoloaders in solver. This only makes
# sense for dev-install.
link=false
# This option is only here to enable using the script during build of
# solenv/gdb . We must (or, better, want to :) avoid using the
# installation subpaths (like basis-link), because all libs in solver
# are in the same dir.
flat=false

#  b de gh jklmno qrstuvwxyzABCDEFGHIJK MNOPQRSTUVWXYZ0123456789
while getopts :a:cfi:p:L opt; do
    case ${opt} in
        a) autoloaddir="${OPTARG}" ;;
        c) create=true ;;
        f) flat=true ;;
        i) installdir="${OPTARG}" ;;
        p) pythondir="${OPTARG}" ;;
        L) link=true ;;
        *) die "unknown option ${OPTARG}" ;;
    esac
done

if [[ -z ${autoloaddir} && -z ${installdir} ]]; then
    autoloaddir="${INSTALLDIR}"
    installdir="${INSTALLDIR}"
elif [[ -n ${autoloaddir} && -z ${installdir} ]]; then
    installdir="${autoloaddir}"
elif [[ -z ${autoloaddir} && -n ${installdir} ]]; then
    autoloaddir="${installdir}"
fi

${create} && ${link} && die "-c and -L cannot be used together"
if [[ -n ${DESTDIR} ]]; then
    [[ ${autoloaddir:0:1} = / ]] || die 'the arg to -a must be an absolute path'
    [[ ${pythondir:0:1} = / ]] || die 'the arg to -p must be an absolute path'
fi
if ${create}; then
    [[ ${autoloaddir:0:1} = / ]] || die 'the arg to -a must be an absolute path'
else
    [[ ! -d ${DESTDIR}${autoloaddir} ]] && die "directory '${DESTDIR}${autoloaddir}' does not exist"
fi
[[ ! -d ${DESTDIR}${installdir} ]] && die "directory '${DESTDIR}${installdir}' does not exist"
[[ ! -d ${GDBDIR} ]] && die "directory '${GDBDIR}' does not exist"

if [[ ${DESTDIR}${pythondir} != ${GDBDIR} ]]; then
    mkdir -p "${DESTDIR}${pythondir}" || die "cannot create dir '${DESTDIR}${pythondir}'"
    cp -r "${GDBDIR}/libreoffice" "${DESTDIR}${pythondir}"
fi

make_autoload cppu basis-link/ure-link/lib libuno_cppu.so.3
make_autoload sal basis-link/ure-link/lib libuno_sal.so.3
make_autoload svl basis-link/program libsvllo.so
make_autoload sw basis-link/program libswlo.so
make_autoload tl basis-link/program libtllo.so

# vim:set shiftwidth=4 softtabstop=4 expandtab:
