
# remove aliases set by *Env.Set.sh
unalias mkout
unalias deliver
unalias build
unalias build_client
unalias zipdep
unalias nmake
unalias gunzip

# executables are *.exe for WNT. This variable is necessary since Cygwin 1.5.x
# Use spawn instead of fork when building dmake on cygwin. 
if test "$GUI" = "WNT"; then
    EXEEXT=".exe"
    DMAKE_CONF="--enable-spawn"
else
    EXEEXT=""
    DMAKE_CONF=""
fi
export EXEEXT

# ------------------------------------------------------------------------------
# Build dmake

if test "$BUILD_DMAKE" != "NO"; then

    if test ! -x "$SOLARENV/$OUTPATH/bin/dmake$EXEEXT"; then

        cd "$SRC_ROOT/dmake" || exit

        # Special case! The w32/tcsh build needs CC pointing to the MSVC++ compiler
        # but we need a cygwin/gcc build dmake to understand the posix paths
        if test "$GUI" = "WNT"; then
            CC=""
            CXX=""
            export CC
            export CXX
        fi

        # For normal unixy systems
        if test -f "Makefile" ; then
            $GNUMAKE distclean || exit
        fi

        ./configure $DMAKE_CONF || exit

        ## invoke the gnu make command set by configure.
        $GNUMAKE || exit

        echo ""
        echo "dmake has been successfully built"

        cd ..

    else

        echo ""
        echo "dmake present in $SOLARENV/$OUTPATH/bin/dmake$EXEEXT"

    fi

fi

mkdir -p "$SOLARENV/$OUTPATH/bin"
if test "$BUILD_DMAKE" != "NO"; then
    cp -f "$SRC_ROOT/dmake/dmake$EXEEXT" "$SOLARENV/$OUTPATH/bin" || exit
    echo ""
    echo "dmake copied to $SOLARENV/$OUTPATH/bin/dmake$EXEEXT"
fi

if test "$GUI" = "WNT" -a ! -x "$SOLARENV/$OUTPATH/bin/guw$EXEEXT"; then
  echo ""
  echo "Calling $GNUMAKE in guw"
  cd "$SRC_ROOT/guw" || exit
  $GNUMAKE || exit
  echo ""
  echo "guw has been successfully made"
  cp -f "$SRC_ROOT/guw/guw$EXEEXT" "$SOLARENV/$OUTPATH/bin" || exit
  echo ""
  echo "guw copied to $SOLARENV/$OUTPATH/bin/guw$EXEEXT"
fi

#make sure build.pl is executable 

chmod +x "$SRC_ROOT/solenv/bin/build.pl"
chmod +x "$SRC_ROOT/solenv/bin/build_client.pl"
chmod +x "$SRC_ROOT/solenv/bin/zipdep.pl"
chmod +x "$SRC_ROOT/solenv/bin/gccinstlib.pl"

# fetch or update external tarballs
if [ "$DO_FETCH_TARBALLS" = "yes" ]; then
	$SRC_ROOT/fetch_tarballs.sh $SRC_ROOT/ooo.lst
fi
