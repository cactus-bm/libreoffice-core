# @configure_input@

SHELL=/usr/bin/env bash

ifeq (@CROSS_COMPILING@,YES)
CROSS_TOOLSET_RULE:=cross-build-toolset
else
CROSS_TOOLSET_RULE:=
endif

ifeq ($(filter all check unitcheck,$(MAKECMDGOALS)),)
gb_MAKETARGET=build
else
# fail early
gb_MAKETARGET=all
endif

.PHONY : build dev-install all cross-build-toolset install distro-pack-install clean clean-host clean-build distclean findunusedcode bootstrap

define forward_to_gbuild
@GNUMAKE@ -f $(dir $(realpath $(firstword $(MAKEFILE_LIST))))/GNUmakefile.mk \
	$(if @VERBOSE@,,-s) \
	--jobs="@GMAKE_PARALLELISM@" \
	$(patsubst allcheck,check,$(1))
endef

define forward_to_buildpl
. ./Env.Host.sh && cd $(1) && gb_MAKETARGET=$(gb_MAKETARGET) build.pl -P@BUILD_NCPUS@ -- -P@BUILD_MAX_JOBS@
endef

ifeq (@CROSS_COMPILING@,YES)
define all_install
To install, issue: @GNUMAKE@ install
Developers might prefer this way: @GNUMAKE@ dev-install -o build
To run smoketest, issue: @GNUMAKE@ check
endef
else
allinstall=For crosscompiles, please consult README.cross how to install it.
endif

UNAMESYSTEM=$(shell uname -s)

ifeq ($(UNAMESYSTEM),Linux)
devinstall_run=make debugrun
else
ifeq ($(UNAMESYSTEM),Linux)
devinstall_run=open @abs_builddir@/install/LibreOffice.app
else
define devinstall_run
cd @abs_builddir@/install/program
. ./ooenv
./soffice.bin
endef
endif
endif

all: build unitcheck
	$(info)
	$(info LibreOffice build succesfully finished.)
	$(info)
	$(info $(all_install))
	$(info)

build: Makefile bootstrap src.downloaded $(CROSS_TOOLSET_RULE)
	@$(call forward_to_buildpl,instsetoo_native)

smoketest: Makefile bootstrap src.downloaded $(CROSS_TOOLSET_RULE)
	@$(call forward_to_buildpl,smoketestoo_native) && \
            rm -f "@abs_builddir@"/install && \
            ln -s "$$SOLARVER/$$INPATH"/installation/opt/ "@abs_builddir@"/install

dev-install: smoketest
	$(info)
	$(info Developer installation finished, you can now execute:)
	$(info)
	$(info $(devinstall_run))

check : allcheck
	@true

cross-build-toolset:
	$(call forward_to_buildpl,cross_toolset)

install: build
	@. ./Env.Host.sh && \
	echo "Installing in @INSTALLDIR@..." && \
	ooinstall "@INSTALLDIR@" && \
	echo "" && \
	echo "Installation finished, you can now execute:" && \
	echo "@INSTALLDIR@/program/soffice"

distclean: clean
ifeq (@BUILD_DMAKE@,YES)
	-test -f dmake/Makefile && $(MAKE) -C dmake distclean
endif
	rm -rf Env.Host.sh Makefile aclocal.m4 autogen.lastrun autom4te.cache \
	bin/repo-list build_env config.log config.status configure \
	desktop/scripts/soffice.sh ooo.lst post_download post_download.log \
	set_soenv set_soenv.last set_soenv.stamp src.downloaded warn

clean: clean-host clean-build

clean-host:
	. ./Env.Host.sh && \
	rm -rf */$$INPATH && \
	rm -rf install

clean-build:
ifeq (@BUILD_DMAKE@,YES)
	. ./Env.Host.sh && \
	(if [ -f dmake/Makefile ] ; then $$GNUMAKE -C dmake clean; fi) && \
	rm -f solenv/*/bin/dmake*
endif
ifeq (@CROSS_COMPILING@,YES)
	. ./Env.Host.sh && \
	rm -rf */$$INPATH_FOR_BUILD
endif

ifeq (@DO_FETCH_TARBALLS@,YES)
fetch: src.downloaded
	$(call forward_to_gbuild,$@)
else
fetch:
	@echo "Automatic fetching of external tarballs is disabled."
endif

ifeq ($(filter clean distclean,$(MAKECMDGOALS)),)
Makefile: autogen.lastrun configure.in ooo.lst.in set_soenv.in Makefile.in
	./autogen.sh
endif

bootstrap:
	$(call forward_to_gbuild,$@)

debugrun:
	@$(call forward_to_gbuild,$@)

%check:
	@$(call forward_to_gbuild,$@)

distro-pack-install: install
	@$(call forward_to_gbuild,$@)

id:
	@$(call forward_to_gbuild,$@)

tags:
	@$(call forward_to_gbuild,$@)

docs:
	@$(call forward_to_gbuild,$@)

findunusedcode:
# experimental callcatcher target
# http://www.skynet.ie/~caolan/Packages/callcatcher.html
	@which callcatcher > /dev/null 2>&1 || \
	 (echo "callcatcher not installed" && false)
	@. ./Env.Host.sh && \
           mkdir -p $$SRC_ROOT/solenv/callcatcher/bin && \
	   ln -sf $$SRC_ROOT/solenv/$$INPATH/bin/dmake \
                  $$SRC_ROOT/solenv/callcatcher/bin/dmake && \
	   source <(sed -e s,$$INPATH,callcatcher,g ./Env.Host.sh) && \
	   . ./solenv/bin/callcatchEnv.Set.sh && \
	   cd instsetoo_native && \
	   build.pl -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@
	@. ./Env.Host.sh && \
	   source <(sed -e s,$$INPATH,callcatcher,g ./Env.Host.sh) && \
	   callanalyse \
		   $$WORKDIR/LinkTarget/*/* \
		   */$$OUTPATH/bin/* \
		   */$$OUTPATH/lib/* > unusedcode.all
#because non-c++ symbols could be dlsymed lets make a list of class level
#unused methods which don't require much effort to determine if they need
#to be just removed, or put behind appropiate platform or debug level ifdefs
	@grep ::.*\( unusedcode.all | grep -v ^cppu:: > unusedcode.easy

#as long as we are not completely gbuildified we need to explicitly depend on the build/install
unitcheck: build
subsequentcheck: dev-install
allcheck : dev-install
#debugrun : dev-install # disabled for now, this dep seems to poison the debugrun !?
