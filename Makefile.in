# @configure_input@

SHELL=/usr/bin/env bash

ifeq ($(USE_GMAKE),)
GBUILD_OPT:=
else
GBUILD_OPT:=--gmake
endif

prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@

ifeq (@CROSS_COMPILING@,YES)
all: Makefile dmake/dmake@EXEEXT_FOR_BUILD@ src.downloaded cross-build-toolset
else
all: Makefile dmake/dmake@EXEEXT_FOR_BUILD@ src.downloaded
endif
	@. ./*Env.Set.sh && \
        cd instsetoo_native && \
        build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@

ifeq (@CROSS_COMPILING@,YES)
cross-build-toolset:
	. ./Env.Build.sh && \
	(cd idlc && build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@ && deliver.pl) && \
	(cd icu && build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@) && \
	(cd udkapi && build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@ && deliver.pl) && \
	(cd ridljar && build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@ && deliver.pl)
endif

install:
	@. ./*Env.Set.sh && \
	echo "Installing in $${libdir:-@libdir@}/@INSTALL_DIRNAME@..." && \
	ooinstall "$${libdir:-@libdir@}/@INSTALL_DIRNAME@" && \
	echo "" && \
	echo "Installation finished, you can now execute:" && \
	echo "$${libdir:-@libdir@}/@INSTALL_DIRNAME@/program/soffice"

dev-install:
	@. ./*Env.Set.sh && \
        cd smoketestoo_native && \
		export SAL_USE_VCLPLUGIN="svp" && \
		build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@ && \
		cd @abs_builddir@ && ln -s $$SOLARVER/$$INPATH/installation/opt/ install && \
		echo "" && \
        echo "Developer installation finished, you can now execute:"
	@if test `uname -s` = Darwin; then \
		echo open install/LibreOffice.app; \
	else \
	        echo "cd @abs_builddir@/install/program" && \
		echo ". ooenv" && \
		echo "./soffice.bin"; \
	fi

distclean:
	-rm config.cache
	-rm config.log
ifeq (@BUILD_DMAKE@,YES)
	-$(GNUMAKE) -C dmake distclean
endif

clean:
	. ./*Env.Set.sh && \
	rm -rf */$$INPATH && \
	rm -rf solver/*/$$INPATH && \
	rm -rf install && \
	$$GNUMAKE -C dmake clean && \
	rm -f solenv/*/bin/dmake* && \
	$$GNUMAKE -f GNUmakefile.mk -sr clean
ifeq (@CROSS_COMPILING@,YES)
	. ./*Env.Set.sh && \
	rm -rf */$$INPATH_FOR_BUILD && \
	rm -rf solver/*/$$INPATH_FOR_BUILD
endif

dmake/dmake@EXEEXT_FOR_BUILD@:
	./bootstrap

src.downloaded: ooo.lst download
	@. ./*Env.Set.sh && \
	$$SRC_ROOT/download $$SRC_ROOT/ooo.lst && touch $@

fetch: src.downloaded

Makefile: configure.in set_soenv.in Makefile.in
	./autogen.sh

check: Makefile dmake/dmake@EXEEXT_FOR_BUILD@ fetch
	@. ./*Env.Set.sh && \
	cd smoketestoo_native && \
	export SAL_USE_VCLPLUGIN="svp" && \
        build.pl $(GBUILD_OPT) -P@BUILD_NCPUS@ --all -- -P@BUILD_MAX_JOBS@
	@. ./*Env.Set.sh && $$SOLARENV/bin/subsequenttests

id:
	@. ./*Env.Set.sh && \
		create-ids

tags:
	@. ./*Env.Set.sh && \
		create-tags

docs:
	@. ./*Env.Set.sh && \
		mkdocs.sh $$SRC_ROOT/docs $$SOLARENV/inc/doxygen.cfg
